# Layers

## Overview

```
╔════════════════════════════════════╗
║ Domain (Core)                      ║  Pure business logic
║ Entities, Value Objects, Events    ║  Zero dependencies
╚═══════════════╦════════════════════╝
                ║
╔═══════════════╩════════════════════╗
║ Application                        ║  Orchestration
║ Use Cases, Ports (interfaces)      ║  Depends on: Domain
╚═══════════════╦════════════════════╝
                ║
╔═══════════════╩════════════════════╗
║ Adapters                           ║  External world
║ Controllers, Repositories, APIs    ║  Depends on: All
╚════════════════════════════════════╝
```

## Domain Layer

**Location:** `src/domain/`

```
domain/
├── user/
│   ├── User.ts           # Entity
│   ├── Email.ts          # Value Object
│   └── events/
│       └── UserCreatedEvent.ts
└── shared/
    └── Address.ts        # Shared VO
```

### Allowed Imports
```typescript
import { Entity, Result, UUID } from '@packages/ddd-kit'
import { Email } from './Email'
```

### Forbidden Imports
```typescript
import { db } from '@packages/drizzle'        // ❌
import { NextRequest } from 'next/server'      // ❌
import { z } from 'zod'                        // ❌
import { SomeUseCase } from '@/application/..' // ❌
```

## Application Layer

**Location:** `src/application/`

```
application/
├── use-cases/
│   ├── CreateUserUseCase.ts
│   └── GetUserByIdUseCase.ts
└── ports/
    ├── IUserRepository.ts
    └── IEmailService.ts
```

### Use Case Pattern
```typescript
export class CreateUserUseCase implements UseCase<Input, User> {
  constructor(private readonly userRepo: IUserRepository) {}

  async execute(input: Input, trx?: Transaction): Promise<Result<User>> {
    const emailOrError = Email.create(input.email)
    if (emailOrError.isFailure) return Result.fail(emailOrError.error)

    const userOrError = User.create({ email: emailOrError.value })
    if (userOrError.isFailure) return Result.fail(userOrError.error)

    return await this.userRepo.create(userOrError.value, trx)
  }
}
```

### Port (Interface)
```typescript
export interface IUserRepository extends BaseRepository<User> {
  findByEmail(email: string): Promise<Result<Option<User>>>
}
```

## Adapters Layer

**Location:** `src/adapters/`

```
adapters/
├── in/api/
│   └── users/route.ts    # HTTP handlers
└── out/
    ├── persistence/
    │   ├── DrizzleUserRepository.ts
    │   └── mappers/UserMapper.ts
    └── email/
        └── SendGridEmailService.ts
```

### Route Handler
```typescript
export async function POST(request: Request) {
  const body = await request.json()
  const validation = schema.safeParse(body)
  if (!validation.success) return Response.json({ error: validation.error }, { status: 400 })

  const useCase = getInjection('CreateUserUseCase')
  const result = await useCase.execute(validation.data)

  if (result.isFailure) return Response.json({ error: result.error }, { status: 400 })
  return Response.json(result.value, { status: 201 })
}
```

### Repository Implementation
```typescript
export class DrizzleUserRepository implements IUserRepository {
  async findById(id: UUID, trx?: Transaction): Promise<Result<Option<User>>> {
    const database = trx ?? db
    const row = await database.query.users.findFirst({ where: eq(users.id, id.value) })
    if (!row) return Result.ok(None())
    return Result.ok(Some(UserMapper.toDomain(row).value))
  }
}
```

## Next Steps

- [Dependency Rule](/docs/architecture/dependency-rule)
- [First Use Case](/docs/guides/first-use-case)
