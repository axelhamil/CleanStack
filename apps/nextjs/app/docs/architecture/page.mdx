# Clean Architecture

## The Dependency Rule

**All dependencies point INWARD.** Domain has ZERO external dependencies.

```
Adapters → Application → Domain
   |           |            |
Database    Use Cases    Business Logic
Next.js     Ports        (zero deps)
```

## The 3 Layers

### 1. Domain (Core)

**Location:** `src/domain/`

Contains Entities, Value Objects, Aggregates, Domain Events.

```typescript
// ✅ ONLY import from ddd-kit
import { Entity, Result, UUID } from '@packages/ddd-kit'

export class User extends Entity<UserProps> {
  canPlaceOrder(): boolean {
    return this.get('isActive') && !this.get('isBanned')
  }
}
```

**Rules:**
- ❌ No imports from Application or Adapters
- ❌ No frameworks (Next.js, Drizzle, Zod)
- ✅ Only `@packages/ddd-kit`

### 2. Application (Orchestration)

**Location:** `src/application/`

Contains Use Cases and Ports (interfaces).

```typescript
// ✅ Import from Domain + define interfaces
import { User } from '@/domain/user/User'
import type { IUserRepository } from '@/application/ports/IUserRepository'

export class CreateUserUseCase implements UseCase<Input, User> {
  constructor(private readonly userRepo: IUserRepository) {} // Interface!

  async execute(input: Input): Promise<Result<User>> {
    // Orchestration logic
  }
}
```

**Rules:**
- ✅ Can import Domain
- ✅ Defines interfaces (ports)
- ❌ No imports from Adapters

### 3. Adapters (External)

**Location:** `src/adapters/`

```
adapters/
├── in/api/        # Route handlers, controllers
└── out/           # Repository implementations
    └── persistence/
```

```typescript
// ✅ Implements interfaces
import type { IUserRepository } from '@/application/ports/IUserRepository'
import { db } from '@packages/drizzle'

export class DrizzleUserRepository implements IUserRepository {
  async create(user: User): Promise<Result<User>> {
    await db.insert(users).values(UserMapper.toPersistence(user))
    return Result.ok(user)
  }
}
```

**Rules:**
- ✅ Implements Application ports
- ✅ All external deps live here (Drizzle, Next.js, APIs)

## Request Flow

```
HTTP POST /api/users
    ↓
Route Handler (Zod validation)
    ↓
Use Case (orchestration)
    ↓
Domain (business rules)
    ↓
Repository (Drizzle)
    ↓
Result<User> → JSON Response
```

## Dependency Inversion

Application defines interfaces, Adapters implement them:

```typescript
// Application (interface)
export interface IUserRepository extends BaseRepository<User> {
  findByEmail(email: string): Promise<Result<Option<User>>>
}

// Adapters (implementation)
export class DrizzleUserRepository implements IUserRepository { }

// DI Container
container.bind('IUserRepository').toClass(DrizzleUserRepository)
```

## Benefits

- **Testable** - Domain/Application without DB
- **Swappable** - Change Drizzle→Prisma: only Adapters
- **AI-Friendly** - Clear rules = consistent code generation

## Next Steps

- [Layers Detail](/docs/architecture/layers)
- [Dependency Rule](/docs/architecture/dependency-rule)
- [First Use Case](/docs/guides/first-use-case)
