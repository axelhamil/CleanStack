# Entities & Aggregates

Objects with unique identity.

## Entity vs Value Object

**Value Object:** Identity by attributes, equality by value, examples: Email, Money

**Entity:** Identity by ID (UUID), equality by ID, examples: User, Order

## Entity Structure

```typescript
import { Entity, Result, UUID } from '@packages/ddd-kit'
import type { Email } from './Email'

interface UserProps {
  email: Email
  name: string
  isActive: boolean
}

export class User extends Entity<UserProps> {
  private constructor(props: UserProps, id?: UUID) {
    super(props, id)
  }

  static create(props: { email: Email; name: string }, id?: UUID): Result<User> {
    if (!props.name.trim()) return Result.fail('Name required')
    return Result.ok(new User({
      email: props.email,
      name: props.name.trim(),
      isActive: true
    }, id ?? UUID.create()))
  }

  // Business methods - return NEW instance
  deactivate(): Result<User> {
    if (!this.get('isActive')) return Result.fail('Already inactive')
    return Result.ok(this.clone({ isActive: false }))
  }

  // Business queries
  canPlaceOrder(): boolean {
    return this.get('isActive')
  }
}
```

## Usage

```typescript
// Create
const user = User.create({ email, name: 'Alice' })

// Access props via get()
console.log(user.get('name'))       // "Alice"
console.log(user.get('isActive'))   // true

// Modify (returns NEW instance)
const deactivated = user.deactivate().value
console.log(user.get('isActive'))        // true (original unchanged)
console.log(deactivated.get('isActive')) // false

// Compare by ID
user1.equals(user2) // true if same _id
```

## Entity Methods

```typescript
user.get('name')           // Type-safe property access
user.getProps()            // Shallow copy of all props
user.toObject()            // Plain object (VOs unwrapped)
user.clone({ name: 'Bob' }) // Copy with overrides
user.equals(other)         // Compare by ID
```

## Aggregates

Aggregates = Entity + Domain Events + Child entities.

```typescript
import { Aggregate, Result, UUID } from '@packages/ddd-kit'

export class User extends Aggregate<UserProps> {
  static create(props: CreateUserProps): Result<User> {
    const user = new User(props, UUID.create())

    // Raise domain event
    user.addEvent(new UserCreatedEvent(user._id.value, user.get('email').value))

    return Result.ok(user)
  }
}

// After persistence
await repo.create(user)
user.markEventsForDispatch()
await DomainEvents.dispatch(user._id.value)
```

## Domain Events

```typescript
// Define event
export class UserCreatedEvent implements DomainEvent {
  type = 'UserCreated'
  constructor(
    public aggregateId: string,
    public email: string,
    public occurredAt = new Date()
  ) {}
}

// Subscribe (at app startup)
DomainEvents.subscribe('UserCreated', async (event) => {
  await sendWelcomeEmail(event.email)
})

// Dispatch (after persistence)
user.markEventsForDispatch()
await DomainEvents.dispatch(user._id.value)
```

## Rules

### ✅ Do
```typescript
// Factory method
static create(...): Result<User>

// Use get() for props
this.get('isActive')

// Return new instance
return Result.ok(this.clone({ name: newName }))

// Events after persistence
await repo.create(user)
user.markEventsForDispatch()
```

### ❌ Don't
```typescript
// Public constructor
constructor(public email: string) {}

// Manual getters (unnecessary)
get isActive() { return this._props.isActive }

// Mutation
this._props.name = newName

// Events before persistence
await DomainEvents.dispatch(user._id)
await repo.create(user)  // Can fail!
```

## Next Steps

- [Value Objects](/docs/core-concepts/value-objects)
- [First Use Case](/docs/guides/first-use-case)
